<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Nova Sbe Crypto Exchange</title>
    <link rel="stylesheet" href="../static/styles.css">
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
  try {
    const response_3 = await fetch('https://api.coincap.io/v2/assets');
    const data_3 = await response_3.json();
    console.log(data_3);

    // Extract the names of the coins for autocomplete
    const coinNames = data_3.data.map(coin => coin.id);

    // Get the search input element and datalist element
    const searchInput = document.getElementById('wide-search');
    const dataList = document.getElementById('coins-datalist');

    // Populate the datalist with options
    coinNames.forEach(coinName => {
      const option = document.createElement('option');
      option.value = coinName;
      dataList.appendChild(option);
    });

    const table = document.createElement('table');
    table.className = 'style-table';
 
    // Create table header
    const thead = document.createElement('thead');
    thead.className = 'style-thead';
    const headerRow = document.createElement('tr');
    ['ID', 'Symbol', 'Price'].forEach(headerText => {
      const th = document.createElement('th');
      th.textContent = headerText;
      th.style.textAlign = 'left';
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');
    tbody.className = 'style-tbody';
 
    data_3.data.forEach(coin => {
    const row = document.createElement('tr');
    ['id', 'symbol', 'priceUsd'].forEach((key, index) => { // Make sure to include the index parameter here
        const cell = document.createElement('td');
        if (index === 2) { // Now index is defined and will be equal to 2 for the priceUsd column
            const price = parseFloat(coin[key]).toFixed(2); // Round to 2 decimal places
            cell.textContent = `$${price}`;
        } else {
            cell.textContent = coin[key];
        }
        row.appendChild(cell);
    });
    tbody.appendChild(row);
});
    table.appendChild(tbody);
    const container = document.getElementById('all_coins');
    container.appendChild(table);
  } catch (error) {
    console.error('Error fetching all coins:', error);
  }
  const searchInput = document.getElementById('wide-search');
  const searchButton = document.getElementById('search-button');

  // Function to filter table rows based on the coin name
  function filterTableRows(coinName) {
    const table = document.querySelector('.style-table');
    const tbody = table.querySelector('tbody');
    const rows = tbody.getElementsByTagName('tr');

    Array.from(rows).forEach(row => {
      const cell = row.getElementsByTagName('td')[0]; // Assuming coin name is in the first column
      if (cell) {
        const cellText = cell.textContent || cell.innerText;
        if (cellText.toLowerCase() === coinName.toLowerCase()) {
          row.style.display = ""; // The row matches the search, so show it
        } else {
          row.style.display = "none"; // The row does not match the search, so hide it
        }
      }
    });
  }

  const priceWindow = document.createElement('div');
  priceWindow.classList.add('chart-box');

  // Create another div for the right side
  const rightDiv = document.createElement('div');
  rightDiv.classList.add('chart-box');
  const searchCoinCanvas = document.createElement("canvas");
  searchCoinCanvas.id = "searchCoinCanvas";

  // Create a container div to hold both divs
  const divContainer = document.createElement('div');
  divContainer.classList.add('chart-container'); // Use this class for flexbox layout
  
  console.log('Event listener attached');
  searchButton.addEventListener('click', async () => {
    const coinName = searchInput.value.trim().replace(/\s+/g, '-').toLowerCase();
    const coinName_2 = searchInput.value.trim().toLowerCase();
    if (coinName) {
      filterTableRows(coinName_2);
      try {
        // Fetch coin price from CoinCap API
        const response = await fetch(`https://api.coincap.io/v2/assets/${coinName}`);
        const data = await response.json();
        const { name, priceUsd } = data.data;
        const roundedPrice = parseFloat(priceUsd).toFixed(2);
        console.log(data);
 
        // Fetch user's cash balance from the server
        const response_2 = await fetch('/API_portfolio');
        const data_2 = await response_2.json();
        console.log(data_2);
        const cash = data_2.cash.cash.toFixed(2);
 
        priceWindow.innerHTML = `
              <h2>Do you want to buy ${name}?</h2>
              <p>Current Conditions:</p>
              <table class="price-table">
                <tr>
                  <td>Price of 1 ${name}:</td>
                  <td>$${roundedPrice}</td>
                </tr>
                <tr>
                  <td>Available Cash:</td>
                  <td>$${cash}</td>
                </tr>
                <tr>
                  <td>Maximum Possible Amount:</td>
                  <td id='max_amount'>${(cash / roundedPrice).toFixed(2)}</td>
                </tr>
              </table>
              <div id="buy-form">
              <form action="/searchcoins" method="post">
                <label for="amount">Amount:</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0" required>
                <input type="hidden" id="symbol" name="symbol" value="${coinName}">
                <button type="submit" class="buy-button">Buy Now</button>
              </form>
              </div>
            `;

            async function fetchDataAndRenderChart() {
            try {
                // Await the fetch call to complete and get the response
                const response_searchChoin = await fetch(`https://api.coincap.io/v2/assets/${coinName}/history?interval=d1`);

                // Await the conversion of the response to JSON
                const data_searchChoin = await response_searchChoin.json();

                // Once the data is obtained, call the function to render the chart
                renderChart(data_searchChoin);
            } catch (error) {
                // Log any errors that occur during the fetch or rendering process
                console.error("Failed to fetch or render chart:", error);
            }
        }

        async function renderChart(data_searchChoin) {
            const ctx = document.getElementById('searchCoinCanvas').getContext('2d');
            const labels = data_searchChoin.data.map(item => new Date(item.time).toLocaleDateString());
            const dataPoints = data_searchChoin.data.map(item => parseFloat(item.priceUsd));

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price USD',
                        data: dataPoints,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        fetchDataAndRenderChart();


          // Analytics Chart Content
          rightDiv.innerHTML = `
            <h2>${coinName} development over time</h2>
            <canvas id="searchCoinCanvas"></canvas>
          `;
          //rightDiv.appendChild(searchCoinCanvas);

          // Append both divs to the container
          divContainer.appendChild(priceWindow);
          divContainer.appendChild(rightDiv);

          // Append the container div to the main container instead of just the priceWindow
          const container = document.getElementById('container');
          container.appendChild(divContainer);
 
        // Pre-populate the symbol input field and show the buy form
        document.getElementById('symbol').value = coinName;
        document.getElementById('buy-form').style.display = 'block';

        // Show analytics graphs
        const analyticsWindow = document.getElementById('analytics');
        // JUSTIN add analytics code inside the try block here (All necessary data for analytics is in "data")
        const response_5 = await fetch(`https://api.coincap.io/v2/assets/${coinName}/history?interval=d1`)
        const data_5 = await response_5.json();
        console.log(data_5);

      } catch (error) {
        priceWindow.textContent = 'Error fetching coin price';
        document.getElementById('buy-form').style.display = 'none';
      }
    } else {
      priceWindow.textContent = 'Please enter a coin name';
      document.getElementById('buy-form').style.display = 'none';
    }

    const buyForm = document.getElementById('buy-form');
    buyForm.addEventListener('submit', async (e) => {
    const numCoinsToBuy = parseFloat(document.getElementById('amount').value);
    const maxAmountElement = document.getElementById('max_amount'); // Get the max amount element
    const maxAmount = parseFloat(maxAmountElement.textContent); // Parse its content as float
    if (isNaN(numCoinsToBuy) || numCoinsToBuy <= 0) {
      e.preventDefault();
      alert('Please enter a valid amount');
    }
    else if (numCoinsToBuy > maxAmount) {
      e.preventDefault();
      alert('Insufficient funds');
    }
    else  {
      return;
    } 
  });
  });

});
</script>
  </head>
  <body>
    <header>
      <div class="header-container">
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/NovaSBE_Logo.svg/2560px-NovaSBE_Logo.svg.png"
          alt="Nova Sbe Logo" class="logo">
        <h1>NOVA SBE Crypto Exchange</h1>
        <div class="logout">
          <a href="/logout" class="logout-button">
            <button class="logout-button">Logout</button>
          </a>
        </div>
      </div>
    </div>
    </header>
    <nav class="navigation">
      <a href="/" class="nav-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
          fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
          <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
          <path fill-rule="evenodd"
            d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
        </svg> Account
      </a>
      <a href="/searchcoins" class="nav-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
          fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
          <path
            d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
        </svg> Search Coins
      </a>
      <a href="/history" class="nav-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
          fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16">
          <path
            d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022zm2.004.45a7 7 0 0 0-.985-.299l.219-.976q.576.129 1.126.342zm1.37.71a7 7 0 0 0-.439-.27l.493-.87a8 8 0 0 1 .979.654l-.615.789a7 7 0 0 0-.418-.302zm1.834 1.79a7 7 0 0 0-.653-.796l.724-.69q.406.429.747.91zm.744 1.352a7 7 0 0 0-.214-.468l.893-.45a8 8 0 0 1 .45 1.088l-.95.313a7 7 0 0 0-.179-.483m.53 2.507a7 7 0 0 0-.1-1.025l.985-.17q.1.58.116 1.17zm-.131 1.538q.05-.254.081-.51l.993.123a8 8 0 0 1-.23 1.155l-.964-.267q.069-.247.12-.501m-.952 2.379q.276-.436.486-.908l.914.405q-.24.54-.555 1.038zm-.964 1.205q.183-.183.35-.378l.758.653a8 8 0 0 1-.401.432z" />
          <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0z" />
        </svg> Transaction History
      </a>
    </nav>
    <main>
      <div class="wide-search">
        <input type="text" class="dashboard-input"
          placeholder="Search for coins..." id="wide-search" list="coins-datalist">
          <datalist id="coins-datalist">
            <!-- Options will be dynamically populated here by the script -->
          </datalist>
        <button type="button" class="search-button"
          id="search-button">Search</button>
      </div>
      <div id="container">
        <!-- Search results and price display will be added here dynamically -->
      </div>
      <div id="buy-form" style="display: none;">
        <form action="/searchcoins" method="post">
          <div>
            <input autocomplete="on" id="symbol" name="symbol" type="text"
              style="display: none;">
          </div>
        </form>
        <div id="analyticsWindow">
          // dynamically add analytics graphs here -> JUSTIN
          <!-- Graphs will be added here dynamically -->
        </div>
      </div>
      <div id="all_coins" class="specific-content">
        <!-- Table of all available coins will be added here dynamically -->
        <h2 class="table-title">Available Coins</h2>
      </div>
    </main>
    <footer>
      <p>&copy; 2023 Nova Sbe Crypto Exchange</p>
    </footer>
  </body>
</html>