<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Nova Sbe Crypto Exchange</title>
  <link rel="stylesheet" href="../static/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <style>
    .navigation {
      text-align: center;
    }
    .nav-button {
      margin: 10px;
    }
    .price-window {
      margin-top: 10px;
      padding: 10px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-weight: bold;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
  try {
    const response_3 = await fetch('https://api.coincap.io/v2/assets');
    const data_3 = await response_3.json();
    console.log(data_3);
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    ['Name', 'Symbol', 'Price'].forEach(headerText => {
      const th = document.createElement('th');
      th.textContent = headerText;
      th.style.textAlign = 'left';
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    data_3.data.forEach(coin => {
      const row = document.createElement('tr');
      ['name', 'symbol', 'priceUsd'].forEach(key => {
        const cell = document.createElement('td');
        cell.textContent = coin[key];
        row.appendChild(cell);
      });
      tbody.appendChild(row);
    });
    table.appendChild(tbody);
    const container = document.getElementById('all_coins');
    container.appendChild(table);
  } catch (error) {
    console.error('Error fetching all coins:', error);
  }
  
  const searchInput = document.getElementById('wide-search');
  const searchButton = document.getElementById('search-button');
  const priceWindow = document.createElement('div');
  priceWindow.classList.add('price-window');

  console.log('Event listener attached');
  searchButton.addEventListener('click', async () => {
    const coinName = searchInput.value.trim().toLowerCase();
    if (coinName) {
      try {
        // Fetch coin price from CoinCap API
        const response = await fetch(`https://api.coincap.io/v2/assets/${coinName}`);
        const data = await response.json();
        const { name, priceUsd } = data.data;
        const roundedPrice = parseFloat(priceUsd).toFixed(2);
        console.log(data);

        // Fetch user's cash balance from the server
        const response_2 = await fetch('/API_portfolio');
        const data_2 = await response_2.json();
        console.log(data_2);
        const cash = data_2.cash.cash.toFixed(2);
        priceWindow.innerHTML = `Price of 1 ${name}: $${roundedPrice}<br>Available Cash: $${cash}<br>Maximum Possible Amount: ${(cash / roundedPrice).toFixed(2)}`;

        // Show the buy form
        document.getElementById('buy-form').style.display = 'block';
      } catch (error) {
        priceWindow.textContent = 'Error fetching coin price';
      }
    } else {
      priceWindow.textContent = 'Please enter a coin name';
    }
    const container = document.getElementById('container');
    container.appendChild(priceWindow);
  });

  const buyForm = document.getElementById('buy-form-element');
  buyForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const numCoinsToBuy = parseFloat(document.getElementById('buy-input').value);
    console.log('Buying', numCoinsToBuy, 'coins...');
  });
});
  </script>
</head>
<body>
  <header>
    <div class="header-container">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/NovaSBE_Logo.svg/2560px-NovaSBE_Logo.svg.png" alt="Nova Sbe Logo" class="logo">
      <h1>Nova Sbe Crypto Exchange</h1>
      <div class="logout">
        <a href="/logout" class="logout-button">
          <button class="logout-button">Logout</button>
        </a>
      </div>
    </div>
  </header>
  <nav class="navigation">
    <a href="/" class="nav-button">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
        <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
      </svg> Account
    </a>
    <a href="/searchcoins" class="nav-button">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
      </svg> Search Coins
    </a>
    <a href="/history" class="nav-button">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16">
        <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022zm2.004.45a7 7 0 0 0-.985-.299l.219-.976q.576.129 1.126.342zm1.37.71a7 7 0 0 0-.439-.27l.493-.87a8 8 0 0 1 .979.654l-.615.789a7 7 0 0 0-.418-.302zm1.834 1.79a7 7 0 0 0-.653-.796l.724-.69q.406.429.747.91zm.744 1.352a7 7 0 0 0-.214-.468l.893-.45a8 8 0 0 1 .45 1.088l-.95.313a7 7 0 0 0-.179-.483m.53 2.507a7 7 0 0 0-.1-1.025l.985-.17q.1.58.116 1.17zm-.131 1.538q.05-.254.081-.51l.993.123a8 8 0 0 1-.23 1.155l-.964-.267q.069-.247.12-.501m-.952 2.379q.276-.436.486-.908l.914.405q-.24.54-.555 1.038zm-.964 1.205q.183-.183.35-.378l.758.653a8 8 0 0 1-.401.432z" />
        <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0z" />
      </svg> Transaction History
    </a>
    <a href="/analytics" class="nav-button">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-fill" viewBox="0 0 16 16">
        <path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1z" />
      </svg> Analytics
    </a>
  </nav>
  <main>
    <div class="wide-search">
      <input type="text" placeholder="Search for coins..." id="wide-search">
      <button type="button" class="search-button" id="search-button">Search</button>
    </div>
    <div id="container">
      <!-- Search results and price display will be added here dynamically -->
    </div>
    <div id="buy-form" style="display: none;">
      <form action="/searchcoins" method="post">
        <div>
            <input autocomplete="off" id="symbol" name="symbol" placeholder="Enter Coin" type="text">
        </div>
        <div>
            <input autocomplete="off" id="amount" name="amount" placeholder="Amount" type="text">
        </div>
        <button type="submit">Buy</button>
    </form>
    </div>
    <div id="all_coins">
      <!-- Table of all available coins will be added here dynamically -->
    </div>
  </main>
  <footer>
    <p>&copy; 2023 Nova Sbe Crypto Exchange</p>
  </footer>
</body>
</html>